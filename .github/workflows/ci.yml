name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend tests
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: dental_db_test
          POSTGRES_USER: dental_user
          POSTGRES_PASSWORD: dental_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      working-directory: ./backend
      run: chmod +x gradlew

    - name: Run backend tests
      working-directory: ./backend
      run: ./gradlew test --info

    - name: Build backend JAR
      working-directory: ./backend
      run: ./gradlew build -x test

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-test-results
        path: backend/build/reports/tests/

  # Frontend tests and build
  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Type check
      working-directory: ./frontend
      run: npm run type-check || echo "Type check not configured"

    - name: Build frontend
      working-directory: ./frontend
      run: npm run build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/

  # OpenSpec validation
  openspec-validate:
    name: Validate OpenSpec
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install OpenSpec CLI
      run: npm install -g @fission-ai/openspec@latest || echo "OpenSpec CLI not available"

    - name: Validate specifications
      run: |
        if [ -f "openspec/config.yaml" ]; then
          echo "OpenSpec configuration found"
          # Add validation commands when available
        else
          echo "OpenSpec config not found, skipping"
        fi

  # Code quality checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check project structure
      run: |
        echo "Checking critical files..."
        test -f "openspec/project.md" || (echo "Missing project.md" && exit 1)
        test -f "openspec/config.yaml" || (echo "Missing config.yaml" && exit 1)
        test -f "docker/docker-compose.yml" || (echo "Missing docker-compose.yml" && exit 1)
        test -f "docker/postgres/init.sql" || (echo "Missing init.sql" && exit 1)
        echo "✅ All critical files present"

    - name: Check for secrets
      run: |
        if grep -r "password123" --exclude-dir=openspec --exclude-dir=.git --exclude="*.md" .; then
          echo "⚠️  Warning: Hardcoded passwords found"
        fi

    - name: Verify .gitignore
      run: |
        if [ ! -f ".gitignore" ]; then
          echo "❌ Missing root .gitignore"
          exit 1
        fi
        echo "✅ .gitignore present"
